<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <script type="text/javascript">
            var PAYMILL_PUBLIC_KEY = 'YOUR_PUBLIC_API_KEY';
            var VALIDATE_CVC = true;
        </script>
        <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap.no-responsive.no-icons.min.css">
        <link rel="stylesheet" type = TEXT/CSS href="css/paymill_styles.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://bridge.paymill.de/"></script>
        <script type="text/javascript" src="lang/translation.js"></script>
        <script type="text/javascript">
            $.noConflict();
            jQuery(document).ready(function ($) {
                var formlang = 'de';
                function translateForm(language){
                    formlang = language;
                    var lang;
                    if(translation[language] === undefined){
                        lang = translation['en'];
                    }else{
                        lang = translation[language];
                    }
                    $(".card-number-label").text(lang["form"]["card-number"]);
                    $(".card-cvc-label").text(lang["form"]["card-cvc"]);
                    $(".card-holdername-label").text(lang["form"]["card-holdername"]);
                    $(".card-expiry-label").text(lang["form"]["card-expiry"]);
                    $(".amount-label").text(lang["form"]["amount"]);
                    $(".currency-label").text(lang["form"]["currency"]);
                    $(".submit-button").text(lang["form"]["submit-button"]);
                    $("#tooltip").attr('title', lang["form"]["tooltip"]);
                }

                $('.card-number').keyup(function() {
                    var brand = paymill.cardType($('.card-number').val());
                    brand = brand.toLowerCase();
                    $(".card-number")[0].className = $(".card-number")[0].className.replace(/paymill-card-number-.*/g, '');
                    if (brand !== 'unknown') {
                        $('#card-number').addClass("paymill-card-number-" + brand);
                    }

                    if (brand !== 'maestro') {
                        VALIDATE_CVC = true;
                    } else {
                        VALIDATE_CVC = false;
                    }
                });

                function PaymillResponseHandler(error, result) {
                    if (error) {
                        // Zeigt den Fehler überhalb des Formulars an
                        if($(".payment-errors").text() === ""){
                            $(".payment-errors").text(error.apierror);
                            $(".payment-errors").css("display","inline-block");
                        }
                    } else {
                        $(".payment-errors").css("display","none");
                        $(".payment-errors").text("");
                        var form = $("#payment-form");
                        // Token
                        var token = result.token;
                        // Token in das Formular einfügen damit es an den Server übergeben wird
                        form.append("<input type='hidden' name='paymillToken' value='" + token + "'/>");
                        form.get(0).submit();
                    }
                    $(".submit-button").removeAttr("disabled");
                }
                $("#payment-form").submit(function (event) {
                    // Absenden Button deaktivieren um weitere Klicks zu vermeiden
                    $('.submit-button').attr("disabled", "disabled");
                    if (false == paymill.validateHolder($('.card-holdername').val())) {
                        $(".payment-errors").text(translation[formlang]["error"]["invalid-card-holdername"]);
                        $(".payment-errors").css("display","inline-block");
                        $(".submit-button").removeAttr("disabled");
                    }
                    if ((false == paymill.validateCvc($('.card-cvc').val()))) {
                        if(VALIDATE_CVC){
                            $(".payment-errors").text(translation[formlang]["error"]["invalid-card-cvc"]);
                            $(".payment-errors").css("display","inline-block");
                            $(".submit-button").removeAttr("disabled");
                        } else {
                            $('.card-cvc').val("000");
                        }
                    }
                    if (false == paymill.validateCardNumber($('.card-number').val())) {
                        $(".payment-errors").text(translation[formlang]["error"]["invalid-card-number"]);
                        $(".payment-errors").css("display","inline-block");
                        $(".submit-button").removeAttr("disabled");
                    }
                    if (false == paymill.validateExpiry($('.card-expiry-month').val(), $('.card-expiry-year').val())) {
                        $(".payment-errors").text(translation[formlang]["error"]["invalid-card-expiry-date"]);
                        $(".payment-errors").css("display","inline-block");
                        $(".submit-button").removeAttr("disabled");
                    }


                    paymill.createToken({
                        number:     $('.card-number').val(),
                        exp_month:  $('.card-expiry-month').val(),
                        exp_year:   $('.card-expiry-year').val(),
                        cvc:        $('.card-cvc').val(),
                        cardholder: $('.card-holdername').val(),
                        amount_int: $('.amount').val() * 100,
                        currency:   $('.currency').val()
                    }, PaymillResponseHandler);
                    return false;
                });
                $("#language_switch").click(function(){
                    var language = formlang;
                    var newimg;
                    if(formlang == 'en'){
                        newimg = "image/gb.png";
                        language = "de";
                    }else{
                        newimg = "image/de.png";
                        language = "en";
                    }
                    $(this).attr("src", newimg);
                    translateForm(language);
                });

                translateForm(formlang);
            });
        </script>
    </head>
    <body>
        <form id="payment-form" class="well span4" action="request.php" method="POST">
            <img src="image/gb.png" id="language_switch" style="float: right;">
            <p class="payment-errors alert-error span3" style="display:none;"></p>
            <div class="controls controls-row">
                <div class="span3">
                    <label class="card-number-label"></label>
                    <input id ="card-number" class="card-number span3" type="text" size="40" value="4111111111111111"/>
                </div>
                <div class="span3">
                    <label class="card-cvc-label"></label>
                    <input class="card-cvc span1" type="text" size="4" value="111"/>
                    <span id="tooltip" style="margin-left:3px; font-size:11px; color:#e2e2e2; padding:0 5px; border-radius:100px; background:#636363;" title="">?</span>
                </div>
            </div>
            <div class="controls controls-row">
                <div class="span3">
                    <label class="card-holdername-label"></label>
                    <input class="card-holdername span3" type="text" size="20" value="lala"/>
                </div>
            </div>
            <div class="controls controls-row">
                <div class="span3">
                    <label class="card-expiry-label"></label>
                    <input class="card-expiry-month span1" type="text" size="2" value="12"/>

                    <span style="float:left;"> / </span>

                    <input class="card-expiry-year span1" type="text" size="4" value="2015"/>
                </div>
            </div>
            <div class="controls controls-row">
                <div class="span2">
                    <label class="amount-label"></label>
                    <input class="amount span2" type="text" size="5" value="10.00" name="amount"/>
                </div>
                <div class="span1">
                    <label class="currency-label"></label>
                    <input class="currency span1" type="text" size="3" value="EUR" name="currency"/>
                </div>
            </div>
            <div class="controls controls-row">
                <div class="span4">
                    <button class="submit-button btn btn-primary" type="submit">Abschicken</button>
                </div>
            </div>
        </form>
    </body>
</html>